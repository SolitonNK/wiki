# Autoextractor API

エクストラクタWeb APIは、オートエクストラクタ定義にアクセス、変更、追加、および削除するためのメソッドを提供します。 すべてのユーザーは、自動抽出のリストとその定義を取得できます。 ただし、自動抽出の定義を追加、変更、削除、または同期できるのは管理者のみです。 バージョン3.0.2以降、自動抽出APIは、非分散モードで動作している場合にのみ使用できます。 分散フロントエンド構成でGravwellクラスターを運用している場合、自動抽出機能を事前にインストールして、手動で管理する必要があります。 自動抽出とその構成の詳細については、[自動抽出]（/＃！configuration / autoextractors.md）セクションを参照してください。

## 定義構造

自動抽出は、次のJSON構造を使用して定義されます（ `module`および` tag`パラメーターを設定する必要があります）：

```
{
	"tag": string,
	"name": string,
	"desc": string,
	"module": string,
	"params": string,
	"arts": string
}
```

## リスティング

autoextractorsをリストするには、 `/api/autoextractors`でGETを実行します。 Webサーバーは、Webサーバーにインストールされた一連の自動抽出プログラムを表すJSON構造のリストを返します。 応答の例は次のとおりです。

```
[
	{
		"name": "testCSVExt",
		"module": "csv",
		"params": "ts, app, id, uuid, src, srcport, dst, dstport, data, name, country, city, hash",
		"tag": "test1"
	},
	{
		"name": "testFieldsExt",
		"desc": "testing extraction",
		"module": "fields",
		"params": "src, dst, extra",
		"tag": "test2"
	}
]
```

## 同期中

自動抽出プログラムのインストール済みセットを変更する操作も、同期操作を呼び出します。 同期操作により、Webサーバーは接続された各インデクサーに変更をプッシュします。 たとえば、10個のインデクサーを使用してGravwellクラスターを実行している場合、新しい自動抽出機能を追加した後、Webサーバーは設定された自動抽出機能セットを各インデクサーにプッシュします。 ただし、ネットワーク接続の問題が原因であるか、変更が発生したときにインデクサーがダウンしている場合でも、障害が発生する可能性があります。 Sync APIを使用すると、手動で同期操作を呼び出して、接続されているすべてのインデクサーを強制的に同じ状態にすることができます。 大規模なGravwellクラスターを管理する場合、新しいインデクサーをオンラインまたは復元した後、同期操作を使用して自動抽出の定義を初期化できます。

同期は、PUTリクエストを `/api/autoextractors/sync`に発行することにより実行されます。 Webサーバーは、成功すると200応答を返し、失敗すると200以外の応答を返します。 部分的に成功した場合（すべてのインデクサーが正常に同期されたわけではありません）、応答の本文に警告構造が返されます。 警告構造は、インデクサー名とエラーのリストです。インデクサーがダウンした場合の応答の例を次に示します。

```
[
	{
		"Name": "net:172.17.0.4:9404",
		"Err": "is disconnected"
	},
	{
		"Name": "net:172.17.0.5:9404",
		"Err": "is disconnected"
	}
]
```

## 追加中

オートエクストラクターの追加は、リクエスト本文に有効な定義JSON構造を指定してPOSTを `/api/autoextractors`に発行することにより実行されます。 構造は有効である必要があり、タグに割り当てられている既存の自動抽出プログラムは存在できません。 新しい自動抽出機能を追加するPOST JSON構造の例：

```
{
	"name": "testCSVExt",
	"desc": "testing extractor",
	"module": "csv",
	"params": "a, b, c, src, dst, extra",
	"tag": "test4"
}
```

自動抽出機能の追加時にエラーが発生した場合、ウェブサーバーはエラーのリストを返します。

## 更新中

オートボイラーの更新は、リクエストボイドの有効な定義JSON構造を使用して、 `/api/autoextractors`にPUTリクエストを発行することで実行されます。 構造は有効でなければならず、同じタグに割り当てられている既存の自動抽出機能が存在する必要があります。 更新された自動抽出機能に関連付けられたタグは、更新APIを介して変更できません。 既存の自動抽出機能に関連付けられているタグを変更するには、定義を削除してから再度追加する必要があります。 データ構造は、追加APIと同じです。 定義が無効な場合、本文にエラーメッセージを含む200以外の応答が返されます。 構造は有効ですが、更新された定義の配布中にエラーが発生した場合、エラーのリストが本文に返されます。

## 抽出構文のテスト

オートエクストラクタを追加または更新する前に、構文を検証すると役立つ場合があります。 `/api/autoextractors/test`に対してPOSTリクエストを行うと、リクエストが検証されます。定義に問題がある場合は、エラーが返されます。

```
{"Error":"asdf is not a supported engine"}
```

新しい自動抽出を追加する場合、新しい抽出が同じタグの既存の抽出と競合しないことが重要です。 既存の抽出を更新する場合、これは問題になりません。 指定されたタグの抽出が既に存在する場合、テストAPIは返された構造に「TagExists」フィールドを設定します。

```
{"TagExists":true,"FileExists":true,"Error":""}
```

「TagExists」がtrueの場合、新しい抽出プログラムを作成する場合はエラーとして扱われ、既存の抽出プログラムを更新する場合は無視されます。

`FileExists`フラグは、提案された抽出がディスク上の既存の抽出を上書きすることを示します。 通常、「TagExists」が設定されている場合にのみ設定されます。 新しいエクストラクターの作成時にはエラーとして扱われ、更新時には無視されます。

## 削除中

既存の自動抽出の削除は、DELETEリクエストを `/api/autoextractors/{id}`に発行することで実行されます。idは自動抽出に関連付けられたタグです。 たとえば、タグ「syslog」に関連付けられている自動抽出を削除するには、リクエストは `/api/autoextractors/syslog`に移動します。 自動抽出プログラムが存在しないか、それを削除するエラーがある場合、Webサーバーは応答本文に200以外の応答とエラーを返します。 削除をインデクサーに配布するときにエラーが発生すると、200の応答と警告のリストが表示されます。

## モジュールのリスト

自動抽出の定義では、有効なモジュールを指定する必要があります。 サポートされているモジュールのリストを取得するAPIは、 `/api/autoextractors/engines`にGETリクエストを発行することで実行されます。 結果のセットは文字列のリストです：

```
[
	"fields",
	"csv",
	"slice",
	"regex"
]
```
