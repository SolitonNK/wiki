# 通知REST API

通知は、1人以上のユーザーに表示されるメッセージです。これは表示されるテキストを含むメッセージフィールドと、オプションでメッセージに関連するURLであるリンクフィールドを含みます。

通知にはTypeを含めることもできます。Typeは、何かが重複せずに継続的に通知を送ることができるように使われます。例えば、ウェブサーバは Type==0xDEADBEEF で `Indexer X is down` という通知を追加し続けることができます。 Typeは同じなので、通知エンジンは古い通知を更新し続けるだけです。

通知には、ターゲット通知とブロードキャスト通知の2つの形式があります。 ブロードキャスト通知はすべての人に届きますが、ターゲット通知は適切なUIDまたはGIDを持つユーザーにのみ届きます。ブロードキャスト通知は本質的にUID/GIDを持ちません(常に0になります)。

注意: 他のユーザーに見える通知を作成できるのは管理者ユーザーだけです。通常のユーザーは、自分自身にのみ表示される通知を作成することができます。

通知にはExpiresフィールドがあり、通知が自動的に削除される日付を指定する。これは通常は空欄のままで、サーバーによって自動入力されます。IgnoreUntilフィールドもオプションである。将来の IgnoreUntilの日付を持つ通知はそれまでリクエストに戻ってこない。空白の日付(Sent、Expires、IgnoreUntil)で通知が追加された場合、それらはデフォルト値で入力されます。

次の通知を考えます:

```
{
    "Broadcast": false,
    "Expires": "2019-04-23T03:44:01.776918756-06:00",
    "GID": 0,
    "IgnoreUntil": "0001-01-01T00:00:00Z",
    "Msg": "foobar",
	"Link": "https://gravwell.io",
    "Origin": "00000000-0000-0000-0000-000000000000",
    "Sender": 7,
    "Sent": "2019-04-22T21:44:01.776942432Z",
    "Type": 1,
    "UID": 7
}
```

この通知はUID 7のユーザーを対象としており、特定のグループを対象としていません。これは同じユーザーによって作成されました。タイプは「1」です。ブロードキャスト通知ではありません。21:44 UTCに送信され、12時間後に有効期限が切れます。メッセージは「foobar」で、https://gravwell.io への関連リンクを持っています。

通知を作成する場合、唯一の *truly* 必須フィールドはMsgです。対象となる通知を作成する場合、GIDおよび/またはUIDも指定する必要があります。LinkとIgnoreUntilフィールドはオプションです。Broadcastフラグは、使用されるAPIエンドポイントに応じてサーバーによって設定されます。

「Origin」フィールドは、インデクサによって生成される自動通知に使用され、無視することができます。

すべての通知は一時的なものです。ウェブサーバ/フロントエンドが再起動すると、それらの通知は失われます。

すべての通知はIDを持ち、それぞれのIDは単調に増加し、常に base-10 uint64 で表されます。

基本的なREST APIのURLは以下の通りです:

```
/api/notifications
/api/notifications/all/{id:[0-9]+}
/api/notifications/{id:[0-9]+}
/api/notifications/broadcast
/api/notifications/targeted
/api/notifications/targeted/self
```

リクエスト方法

GET - 通知をプルバックする
PUT - 特定の通知を更新する
POST - 新しい通知を追加する
DELETE - 特定の通知を削除します。

## 通知ルール

* 新しい通知を追加できるのは、`/api/notifications/targeted/self` apiを介した場合を除き、管理者のみです。
* ユーザーは、自分が明示的に所有している(UIDが一致している)通知しか更新できません。GIDの一致だけでは十分ではありません。
* ユーザーは通知に関連付けられたUIDまたはGIDを変更することはできません。
* ユーザーが所有していない通知を削除できません（UIDが一致しません）

## 新しい通知の追加

### ブロードキャスト通知またはターゲット通知を追加する (管理者専用)

管理者は、通知構造を`/api/notifications/broadcast`にPOSTしてブロードキャスト通知を作成するか、`/api/notifications/targeted`にPOSTしてターゲット通知を作成できます。 明示的なタイプでブロードキャスト通知を作成するには、次のようにPOSTします。

```
{
	"Msg": "This is a broadcast notification"
	"Type": 123
}
```

特定のグループにターゲットを絞った通知は、次のように：

```
{
	"Msg": "This is a targeted notification",
	"GID": 2
}
```

### セルフターゲット通知の追加

管理者以外のユーザは、`/api/notifications/targeted/self`へのPOSTで通知を作成することができます。Type、Msg、Expiresフィールドだけが尊重されることに注意してください。これらの通知はデフォルトで12時間の有効期限に設定されています。Expiresフィールドが過去または未来に24時間以上ある場合、現在の時刻から12時間に設定されます。

```
{
	"Msg": "This is a self-targeted notification"
}
```

## 通知を取得する

ユーザは、`/api/notifications`へのGETリクエストで、すべての通知を取得することができます。特定の通知IDの後に作成されたすべての通知を取得するには、/api/notifications/{id}にGETを発行します。例えば、以前に0から10までの通知を見たことがある場合、/api/notifications/10へのリクエストを行うと、そのユーザーがアクセスできる新しい通知のみを取得することができます。

### すべての通知の取得 (管理者のみ)

管理者は `/api/notifications/all/` で GET を発行することで、(UID や GID に関係なく) すべての通知を取得することができます。

## 通知の更新

通知を更新するには、問題の通知に対して `/api/notifications/{id}` にPUTリクエストを行います。

## 通知の削除

通知を削除するには、特定の通知IDに対して、`/api/notifications/{id}`にDELETEリクエストを送信します。管理者以外のユーザは、自分のUIDを明示的に対象とした通知のみを削除できることに注意してください。
