# 検索制御

REST API は /api/searchctrl にあります。

searchctrlグループは、永続的な検索に関する情報を照会し、オプションで何らかのアクションを実行するために使用されます。 現在のところ、すべてのアクティブな検索の問い合わせ、特定の検索に関する情報の取得、アクティブな検索のバックグラウンド、アクティブな検索のアーカイブ、検索の削除/終了を行う機能を提供しています。

## 基本的なAPIの概要

ここでの基本的なアクションは、REST urlに対してGET、DELETE、PATCHを実行することです。

## 検索の状態

検索は、次のいずれかの状態で行うことができ、一度に複数の状態（ACTIVE/BACKGROUNDED、SAVED/ATTACHED、DORMANT/SAVEDなど）にすることができます。

- Active: 検索が実行中または終了しており、セッションが添付されています。
- Backgrounded: 検索はアクティブに実行されていますが、アタッチされたセッションがなくても持続するようにマークされています。
- Saving: 検索は保存されマークされていますが、その内容を永続的な場所に移動するために完了を待っています。
- Saved: 検索は保存されマークされ、適切な永続的な場所に移動されます。
- Dormant: 検索はキープ（バックグラウンドや保存）されており、セッションは添付されていません。
- Attached: 検索が保存され、セッションが再アタッチされています。

## 検索リストの取得
検索リストを要求すると、ウェブサーバは現在のユーザが閲覧を許可されているすべての検索を返します。 jsonパッケージは投稿されず、'/api/searchctrl' に対して空のGETが実行されます。  

```
[
        {
                "ID": "181382061",
                "UID": 1,
                "GID": 0,
                "State": "ACTIVE",
                "AttachedClients": 1
        },
        {
                "ID": "010985768",
                "UID": 1,
                "GID": 0,
                "State": "BACKGROUNDED",
                "AttachedClients": 0
        },
        {
                "ID": "795927171",
                "UID": 1,
                "GID": 0,
                "State": "DORMANT",
                "AttachedClients": 0
        }
]
```

## 特定の検索の情報を取得する
特定の検索のステータスを取得するには、REST url /api/searchctrl/:ID を GET することで実行されます。

```
WEB GET /api/searchctrl/795927171:
[
	{
		"ID": "795927171",
		"UID": 1,
		"UserQuery": "grep paco | grep chico",
		"EffectiveQuery": "grep paco | grep chico | text",
		"StartRange": "2016-12-22T12:41:27.011080417-07:00",
		"EndRange": "2016-12-22T13:01:27.011080417-07:00",
		"Started": "2016-12-22T13:01:27.01227455-07:00",
		"Finished": "0001-01-01T00:00:00Z",
		"StoreSize": 0,
		"IndexSize": 0
	}
]
```

## 検索のバックグラウンド化

検索のバックグラウンド化は、最後のクライアントが手を放した場合に、検索を継続してもよいことをウェブサーバに通知するために使用されます。検索をバックグラウンドにするには、正しい ID で /api/searchctrl/:ID/background のURLでPATCHを実行してください。このコマンドが成功するためには、検索がアクティブであるか、すでにバックグラウンド化されていなければなりません。

```
WEB PATCH /api/searchctrl/795927171/background:
null
```

## 検索の保存

検索の保存は、検索結果を保存したい旨をウェブサーバに通知するために使用されます。 バックグラウンド検索は、ウェブサーバがディスクスペースを必要としない限り(または明示的に削除されない限り)、(誰も接続していなくても)常駐します。 保存すると結果は保存された場所に移動し、(適切な権限を持つ)誰かが明示的に要求しない限り、結果は削除されません。 検索を保存するには、正しい ID で /api/searchctrl/:ID/save のURLにPATCHを実行してください。  検索はどのような状態にあっても構いませんが、一旦休止状態になった場合にのみ、永続的なストレージへの転送を開始します。 永続的ストレージへの転送は、（永続的ストレージが同じドライブ上にある場合）瞬時に行われるか、完全なコピーが必要です。 これはそれ自身の goroutine でバックグラウンドで行われるので、転送が行われている間は何もブロックされません。

保存された検索にオプションのメタデータを添付することができます。 このメタデータはメモや情報など、JSON blob としてエンコードできるものなら何でも添付することができます。 メタデータは検索を保存するために `PATCH` リクエストの本文にエンコードされなければなりません。

```
WEB PATCH /api/searchctrl/10985768/save:
null
```

## 検索の削除・終了

検索を削除すると、検索が終了し（アクティブなユーザーはすべてキックオフされ）、検索結果に関連付けられたストレージが直ちに削除されます。 検索は、どのような状態であっても削除することができます。 検索を削除するには、/api/searchctrl/:IDに正しいIDを指定してDELETEリクエストを行います。 成功した場合は200、エラーの場合は5XX、ユーザーが検索を修正する権限がない場合は403を返します。

```
WEB DELETE /api/searchctrl/010985768:
null
```

## 管理者API

管理者ユーザーは、上記で説明したAPIエンドポイントを使用して、任意の検索に関する情報を取得したり、検索を削除したり、検索をロードしたり、検索をバックグラウンドに送信したりすることができます。

### すべての検索のリストアップ

システム上に存在するすべての検索のリストを取得するために、管理者ユーザーは `/api/searchctrl/all` でGETすることができます。フォーマットは `/api/searchctrl/all` から返されるものと同じですが、システム上のすべての検索を含みます。

```
[
    {
        "AttachedClients": 0,
        "GID": 0,
        "ID": "486574780",
        "State": "DORMANT",
        "StoredData": 9355,
        "UID": 1
    },
    {
        "AttachedClients": 0,
        "GID": 0,
        "ID": "815623546",
        "State": "DORMANT",
        "StoredData": 3536,
        "UID": 4
    },
    {
        "AttachedClients": 0,
        "GID": 0,
        "ID": "525125903",
        "State": "DORMANT",
        "StoredData": 0,
        "UID": 7
    },
    {
        "AttachedClients": 0,
        "GID": 0,
        "ID": "274379984",
        "State": "DORMANT",
        "StoredData": 319,
        "UID": 4
    }
]

```
