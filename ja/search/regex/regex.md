## Regex

Regexは、正規表現を使ってテキストデータをマッチングさせるパイプラインモジュールです。これは、複雑なパターンをマッチングし、テキストから無数のフィールドを抽出するための非常に強力な方法です。正規表現に慣れていない人は [Wikipediaの記事](https://ja.wikipedia.org/wiki/%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE) をご覧ください。

正規表現の構築はこのドキュメントの範囲外ですが、注意すべき重要な点として、`(?P<foo> .*)` スタイルの構文は、マッチしたグループを列挙フィールド(この場合は「foo」という名前)に代入するということです。これらの列挙フィールドは、分析やチャート作成などを行う際に便利です。

例えば、以下の検索は、sshd Accepted ログエントリからメソッド、ユーザ、および ip を列挙します。

```
".*sshd.*Accepted (?P<method>\S*) for (?P<user>\S*) from (?P<ip>[0-9]+.[0-9]+.[0-9]+.[0-9]+)"
```

正規表現は非常に長くなる可能性があるので、正規表現を含むリソースを指定するための `-r` フラグを regex モジュールは受け取ります。リソースを入力する際には、検索に直接入力するときのように、式全体を「ラッピングクォーテーション」で囲まないようにしてください。これは通常、正規表現モジュールに渡される前に検索パーサによって引用符が取り除かれるためです。

### サポートされているオプション

* `-e <arg>`:「-e」オプションはレコード全体ではなく、列挙された値に対して操作します。例えば、ポート80に向かっていないがHTTPテキストを持つパケットを表示するパイプラインは、`tag=pcap packet ipv4.DstPort!=80 tcp.Payload | regex -e Payload ".*GET \/ HTTP\/1.1.*"`となります。
* `-r <arg>`:「-r」オプションは、正規表現の文がリソースファイルにあることを指定します。
* `-v`:「-v」オプションは、正規表現を逆モードで動作させ、正規表現にマッチするエントリをすべて削除し、マッチしないエントリを渡すように指示します。
* `-p`:「-p」オプションは、正規表現が全く一致しない場合にエントリの通過を許可するようにregexに指示します。 permissive フラグは、フィルタの動作を変更しません。

注意: 特に大きな正規表現をリソースファイルに保存しておくと、クエリをクリーンアップすることができ、再利用が容易になります。「-r」が指定されている場合は、クエリで正規表現を指定しないでください。

### インラインフィルタリング

regexモジュールはインラインフィルタリングをサポートしており、regexモジュール内で直接データの範囲を狭めることができるようになっています。 また、インラインフィルタリングにより、regex はアクセラレータを使用して、処理する必要のあるデータ量を大幅に削減することができます。 インラインフィルタリングは、比較演算子を使用することで、他のモジュールと同様の方法で実現されます。 比較演算子（"equal"、"not equal"、"contains"、"not containing"）を指定するフィルタが有効になっている場合、フィルタの指定に失敗したエントリは完全に削除されます。 等しくない「！=」と指定されたフィールドが存在しない場合、フィールドは抽出されませんが、エントリは完全に削除されません。


| 演算子 | 名前 | 説明 |
|----------|------|-------------|
| == | 等しい | フィールドは等しくなければなりません
| != | 等しくない | フィールドは等しくてはいけません
| ~ | サブセット | フィールドはメンバーでなければなりません
| !~ | サブセットではない | フィールドはメンバーであってはいけません

#### フィルタリングの例

```
tag=syslog regex *shd.*Accepted (?P<method>\S*) for (?P<user>\S*) from (?P<ip>[0-9]+.[0-9]+.[0-9]+.[0-9]+)" user==root ip ~ "192.168"
```

### パラメータの構造
```
regex <argument list> <regular expression> <filter arguments>
```
### 検索例
```
tag=syslog grep sshd | regex *shd.*Accepted (?P<method>\S*) for (?P<user>\S*) from (?P<ip>[0-9]+.[0-9]+.[0-9]+.[0-9]+)"
```
