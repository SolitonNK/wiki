# Stats Module

統計モジュールは、個々の数学モジュールが1つの操作だけを実行する場合に、ユーザーが同時に複数の統計操作を実行することを可能にします。  statsモジュールの標準的な例は、エラーバーをグラフに表示するために値の平均と標準偏差を計算することです。

## 構文

statsモジュールの呼び出しは、次のもので構成されています:

* モジュール名 (`stats`)
* どの列挙値を操作するかを指定する操作のリスト、およびオプションで出力の名前 (`mean(length)`, `count as foo`)
* オプションの"by"引数。by引数の各組み合わせに対して個別に実行することを指定します（ `mean（Length）by SrcIP`のように）

これらの構成要素については後述します。

## 数学演算仕様
 
操作は、操作名、括弧内に含まれる"ソース"列挙値、およびオプションで出力列挙値の別の名前で構成されます。

以下の操作名がサポートされています:

* count: エントリ数
* sum: 合計した値を返す
* mean: 平均値を計算する
* stddev: 標準偏差を計算する
* variance: 分散を計算する
* min: 最小値を返す
* max: 最大値を返す

操作はソース列挙値に対して実行されます。  したがって、指定`stats sum(Bytes)`すると、statsモジュールにBytes列挙値を合計し`sum`、合計を含むという名前の列挙値を持つ単一のエントリを出力するように指示されます。

注：ソースが指定されていない場合は、代わりにエントリーの本体に対して操作が実行されます。  指定stats sumすることは`stats sum(DATA)`を指定することと同等です

複数の操作を指定できます:

```
stats sum(Bytes) mean(Bytes)
```

```
stats mean(Bytes) stddev(bytes) min(Length)
```

オペレーションの出力は、デフォルトでは、オペレーションの名前とともに列挙値に割り当てられます。  したがって、`stats sum（Bytes）`は、出力を保持するために`sum`という名前の列挙値を作成します。  これは`as`オプションで変更できます：

```
stats mean(Bytes) as BytesAvg
```

これは、複数の異なる列挙値に対して同じ操作を実行するときに特に便利です:

```
stats mean(Bytes) as BytesAvg mean(Length) as LengthAvg
```

## "By"引数の指定

ユーザが異なるIPごとに別々に実行される操作を必要とする場合は、"by引数"を指定する必要があります。

```
stats mean(Bytes) stddev(Bytes) by SrcIP
```

これは、各固有のSrcIP値について別々の平均値と標準偏差を計算するようにstatsモジュールに指示します。  結果は、見られる各SrcIPに対して1エントリになり、それぞれに適切なSrcIP、平均値、およびstddev列挙値が含まれます。

必要なだけ引数で指定できます:

```
stats mean(Bytes) stddev(Bytes) by SrcIP DstIP DstPort
```

モジュールは、SrcIP、DstIP、およびDstPortのすべての組み合わせに対して、別々の平均と標準偏差を計算します。

重要：メモリーが限られているシステムで非常に大きなデータセットを扱う場合、statsモジュールが何百万もの組み合わせをメモリー内に保持しようとするため、引数で多すぎる指定をするとメモリー不足につながる可能性があります。

### 複雑な"By"引数の使用

単一の"by"引数のみが提供され、それが最後の操作に適用される場合、統計情報はすべての操作に適用されます。 これは簡単な方法です。すべての操作に適用したくない場合は、最後の操作に"by"引数がないことを確認してください。

たとえば、以下は`SrcIP DstIP DstPort`をキーとして使用して"mean"操作を実行しますが、stddev操作はキーなしで適用されます:

```
stats mean(Bytes) by SrcIP DstIP DstPort stddev(Bytes)
```

statsモジュールは複雑なキーイングを使用して操作を実行できます。 つまり、すべての操作に対してキーセット（またはキーセットの欠如）を提供できます。  これは、単一のテーブルまたはチャートで異なるキーを使用して複数の操作を表示する場合に便利です。

たとえば、IPごとのパケットサイズの合計を実行するが、すべてのパケットのベースライン合計も提供するクエリは次のとおりです:

```
tag=pcap packet ipv4.IP ~ 10.10.10.0/24 | length | stats sum(length) by IP sum(length) as total | chart total sum by IP 
```

![complex keys](complexkey.png)

## タイムウィンドウの指定

statsモジュールは、condensedまたはtemporalの2つのモードで動作できます。

condensedモードでは、結果を1回だけ出力します。  これは、テキストレンダラーの使用時、またはテーブルレンダラーに`-nt`フラグが渡されたときに自動的に発生します。

temporalモードでは、statsモジュールは時間枠で動作し、デフォルトは1秒です。  データの1秒ごとに、モジュールは結果エントリのセットを発行します。  これは、データをチャートレンダラーに送信するときに使用されます。

デフォルトのウィンドウは1秒ですが、ウィンドウサイズは"over"オプションで変更できます:

```
stats mean(Bytes) stddev(Bytes) by SrcIP over 5m
```

チャートモジュールに送信されると、結果は標準の1秒ではなく5分間で計算されます。

注：指定できる時間枠は1つだけで、その時間枠はすべての操作に適用されます。  timewindowは、statsのLAST引数でもある必要があります