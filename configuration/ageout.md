# データエイジアウト

Gravwellは、データ管理ポリシーを個々のウェルに適用できるエイジアウトシステムをサポートしています。 エージアウトポリシーは、データの保持、ストレージウェルの使用率、および圧縮を制御します。 各ウェルは、あるストレージシステムから別のストレージシステムへのデータの移動方法を決定する一連のパラメーターを使用して、ホットストレージとコールドストレージの場所をサポートします。 理想的なGravwellストレージアーキテクチャは、ランダムアクセスに耐える高速ストレージの比較的小さなプールと、長期ストレージに使用される大容量/低コストのストレージプールで構成されています。 NVMEベースのフラッシュドライブやXPointドライブは非常にホットウェルになりますが、磁気RAIDアレイ、NAS、またはSANプールはコールドプールに適しています。 エイジアウト中に検索が妨げられることも、摂取されることもありません。

エージアウトポリシーは、3つのパラメーターで定義できます。

*時間
*総ストレージ
*ストレージの可用性

ストレージの時間コンポーネントにより、ポリシー、契約上の合意、または法的要件に準拠するようにデータ保持ポリシーを指定できます。たとえば、企業のポリシーでは、Webプロキシログを30日以内に保存するように規定されている場合があります。

total storageパラメータは、格納されているデータの量が格納域の境界を超えたときにGravwellにデータのエージングアウトまたは破棄のみを指示する、格納域の上限格納域を指定します。

storage availabilityパラメーターは、Gravwellに少なくとも一定量の使用可能ストレージを維持し、必要に応じてデータを期限切れにしてスペースを解放するように指示します。Gravwellがデバイス上の空きストレージを使用できるようにしたいが、デバイスがある可用性しきい値を下回った場合にデータを破棄する場合は、ストレージ可用性の制約が役立ちます。

単一のWellに複数の制約を追加して、規則を交差させることができます。たとえば、合計が100GBを超えない限り、データを最大90日間保存するように指定できます。

エージアウトシステムは、エントリをホットプールからコールドプールに転送するときにデータストレージを最適化するように設計されています。最適化により、同じタイムレンジとタグのエントリがローカライズされ、従来の回転ディスク上でのヘッドの動きが減少します。最適化フェーズでは、圧縮と組み合わせることで、コールドデータのストレージ使用率と検索パフォーマンスを大幅に向上させることができます。

エージアウトシステムは古いデータを削除するように設定することができるので、Wellエージアウトを開始する前に設定を確認することが非常に重要です。

データエージアウトを有効にするには、各Wellにホット保管場所とコールド保管場所を用意する必要があります。ホットロケーションは、gravwell.confファイルの["Location" directive](parameters.md)を介して指定されます。 コールドストレージの場所は、コールドストレージに使用されるディレクトリへの絶対パスを指定する「Cold-Location」ディレクティブを介して指定されます。 コールドストレージの場所は、他のウェルストレージの場所（ホットまたはコールド）と重複してはなりません。 コールドストレージの場所に加えて、ホットプールからコールドプールにデータをいつどのように移動するかを指示するために、少なくとも1つのエージアウト制約を指定する必要があります。

<span style="color: red; ">重要：エージアウト構成はウェルごとに構成されています。 各ウェルは、他のすべてから独立して非同期的に動作します。 2つのウェルが同じボリュームを共有している場合、ストレージリザーブに基づいてエージアウトディレクティブを有効にすると、1つのウェルが別のウェルの侵入によりデータを積極的に移行または削除する可能性があります。</span>

<span style="color: red; ">注：エージアウトのマークが付けられているストレージシャードまたはアクティブに照会されているストレージシャードにデータがアクティブに着信している場合、エージアウトシステムはシャードのエージングアウトを後で延期します。</span>

### 時間ベースの制限

時間ベースのエージアウトは、時間保持要件に基づいてデータを管理します。たとえば、ある組織では、すべてのログを90日間保存するという要件があります。時間ベースのエージアウト制約は、ポリシーや法的な要件によってログの保存期間が決定されるコールドデータプールに最も適しています。時間ベースの経過期間は、次の大文字と小文字を区別しない略語を使用して日数と週数で指定できます。

* "d" - 日数
* "days" - 日数
* "w" - 週
* "week" - 週

データのホットプールのみを使用し、30日以上経過したデータを削除するWell構成の例：

```
[Storage-Well "syslog"]
	Location=/mnt/xpoint/gravwell/syslog
	Tags=pcap
	Hot-Duration=30D
	Delete-Cold-Data=true
```

7日後にデータがホットプールからコールドプールに移動され、90日後にコールドプールからデータが削除される構成例

```
[Storage-Well "syslog"]
	Location=/mnt/xpoint/gravwell/syslog
	Cold-Location=/mnt/storage/gravwell_cold/syslog
	Tags=pcap
	Hot-Duration=7D
	Cold-Duration=90D
	Delete-Frozen-Data=true
```

<span style="color: red; ">注：上記の構成では、データが97日経過した時点で完全に削除され、ホットプールで7日間、コールドプールで90日間を費やしたことになります。</span>

時間ベースのageoutは1日に1回呼び出され、期限切れになる可能性がある断片について各プールをスイープします。デフォルトでは、スイープはUTCの午前0時に発生しますが、実行時間は、Ageout-Time-Overrideディレクティブを使用したwell設定で上書きできます。オーバーライド指令は、24時間UTC時間で指定されます。

UTC午後7時に発生するようにエージアウトタイムチェックをオーバーライドする設定例

```
[Storage-Well "syslog"]
	Location=/mnt/xpoint/gravwell/syslog
	Cold-Location=/mnt/storage/gravwell_cold/syslog
	Tags=syslog
	Tags=switchlogs
	Hot-Duration=7D
	Cold-Duration=90D
	Delete-Frozen-Data=true
	Ageout-Time-Override=19:00
```

### ストレージベースの総エージアウト

合計ストレージ制約は、期間に関係なく、ボリューム内の特定量のストレージを割り当てます。ストレージの制約により、Gravwellインデクサーはサイズが制限される可能性がある高速ストレージプール（NVMEフラッシュなど）を積極的かつ完全に使用することができます。Wellが許容量を超えて消費していない限り、インデクサーはエントリーをストレージ・プールに保持します。記憶域の制約により、データ記憶域を中断することなく予想外の大量の取り込みが可能になります。たとえば、インデクサに通常7日間のホットストレージを処理する1TBの高速フラッシュストレージがあるが、予期しないデータイベントによって1日に600GBの取り込みが発生した場合、インデクサはデータを中断することなく古いデータをコールドプールに期限切れにすることができます。新しいデータを取り込むホットプールの機能。断片は時間によって優先順位が付けられます。最も古い断片は、温水プールと冷水プールの両方で最初に老化します。

500GBまでのデータをホットプールに保持し、500GBの制限を超えたときに古いデータを削除するWell構成の例：

```
[Storage-Well "windows"]
	Location=/mnt/xpoint/gravwell/windows
	Tags=windows
	Tags=sysmon
	Max-Hot-Storage-GB=500
	Delete-Cold-Data=true
```

ホットプールが約50GBを保持してから最大10TBを保持するコールドプールにエージングアウトする場合のWell構成例：

```
[Storage-Well "windows"]
	Location=/mnt/xpoint/gravwell/windows
	Cold-Location=/mnt/storage/gravwell_cold/windows
	Tags=windows
	Tags=sysmon
	Max-Hot-Storage-GB=50
	Max-Cold-Storage-GB=10000
	Delete-Frozen-Data=true
```

<span style="color: red; ">重要：記憶域ベースの制約は、即時の厳しい制限ではありません。記憶域の割り当てを超えたときにインデクサーがデータを取り込んでいる間にデータを期限切れにすることができるように、必ず少しスペースを空けてください。たとえば、ホットストレージデバイスが512GBを保持でき、システムが通常1日あたり100GBを取り込む場合、ストレージ制限を490GBに設定すると、インデクサがデータを移行している間にホットプールが完全に一杯にならないように十分な余裕があります。</span>

### ストレージの使用率ベース

ストレージの可用性に基づいて、ストレージの制約も適用できます。 一部のウェルは優先度が低く、利用可能な場合にのみストレージを消費します。 ストレージ予約ディレクティブを使用すると、利用可能なストレージの上限がボリュームで維持されている限り、必要なだけのスペースを自由に消費できるウェルを指定できます。 ストレージリザーブパラダイムにより、基本的にウェルは「セカンドクラス」ウェルとして機能し、他の誰もいないときにのみ消費します。 「Hot-Storage-Reserve = 5」を指定すると、ホットストレージボリュームが5％の空き容量を下回ると、ウェルは最も古いシャードの移行または削除を開始します。 reserveディレクティブは、ストレージの場所をホストする基礎となるボリュームに適用されます。つまり、ボリュームが他のウェルまたは他の任意のファイルストレージもホストしている場合、ウェルは必要に応じてストレージの使用を取り戻すことができます。

ボリュームに30％の空き容量がある限りホットロケーションを使用し、10％の空き容量がある限りコールドボリュームを使用するWell構成の例：

```
[Storage-Well "doorlogs"]
	Location=/mnt/xpoint/gravwell/doorlogs
	Cold-Location=/mnt/storage/gravwell_cold/doorlogs
	Tags=badgeaccess
	Hot-Storage-Reserve=30
	Cold-Storage-Reserve=10
	Delete-Frozen-Data=true
```

<span style="color: red; ">注意：ストレージで動作するGravwellエージアウトシステムは、外部の影響に対して完全に直交して動作しています。50％のストレージ上限を守るようにWellが構成され、外部アプリケーションがボリュームを60％まで満たすと、Gravwellはアクティブ外のエントリをすべて削除します。破片。予約済みストレージを使用して構成されたWellは、使い捨てとして扱う必要があります。</span>

### 警告と重要事項

単一のシャードがデータ制約のサイズを超えて大きくなると、シャードがアイドルになるとシャード全体がエージングアウトします。

時間ベースの制約では、シャード全体が指定された時間枠の外にあることが必要です。 そのため、1日未満の時間的矛盾は意味がなく、ホットプールは少なくとも2日間分のデータを保持できる必要があります。

時間ベースの制約と合計ストレージ制約を組み合わせるときは注意してください。 「Hot-Duration = 7D」と「Cold-Duration = 90D」が指定されている場合、データは97日後に削除されます。 ただし、「Max-Hot-Storage-GB = 2」および「Cold-Duration = 90D」が指定されている場合、ホットウェルが2GBを超えるとデータはホットウェルからコールドウェルに移動し、**データは削除されます 90日経ったときに寒い井戸から**。

#### 削除セーフティネット

年齢制限ポリシーはデータを削除することができます。ホットストレージプールとコールドストレージプールの両方が要求されたエージアウト制約を確実に満たすことができるように、管理者が構成とハードウェアリソースを確認することが非常に重要です。適切な構成では、（Delete-X-Data）ディレクティブを介して削除を明示的に許可する必要があります（Delete-Cold-DataホットプールおよびDelete-Frozen-Dataコールドプール用）。

Delete-X-Dataディレクティブは、管理者が構成中のデータ削除について考慮するためのセーフティネットとして使用されます。たとえば、ホットプールがある、コールドプールがない、および7日間のホットリテンションを持つようにWellが構成されている場合、Gravwellは7日より古いホットプールからデータを削除しようとします。しかし、Wellに "Delete-Cold-Data = true"という設定ディレクティブがない場合、エージアウトシステムはデータを削除しません。代わりにログに文句を言い、本質的にエージアウトを無効にします。

コールドプールには同じディレクティブ要件が含まれています。つまり、「Delete-Frozen-Data = true」ディレクティブが設定されていない限り、Gravwellはコールドプールから期限切れになるため、コールドプールからデータを削除しません。 120日前のデータがホットプールに取り込まれ、コールドプール保存設定が90日で、Delete-Cold-Dataディレクティブがtrueに設定されている場合、エージアウトシステムはコールドプールを完全にバイパスして直接削除します。

時間ベースのエージアウトは、システムクロックに基づいてデータをエージングアウトする時期を決定します。つまり、システムクロックが不適切であると、データが早期にエージングアウトされる可能性があります。管理者はシステムクロックが適切に維持されていることを確認する必要があります。NTPが使用されている場合、それは信頼できるソースです。攻撃者がGravwellインデクサーのシステムクロックを妥当な期間にわたって制御することができると、それらはエイジアウトを引き起こす可能性があります。時間はGravwellのアンカーであり、ストレージプールと同じ勢いで保護する必要があります。

### 圧縮

コールドストレージの場所はデフォルトで圧縮されているため、ストレージからCPUに負荷がかかります。Gravwellは、規模の広いパラダイムで最新のハードウェア用に構築された高度に非同期なシステムです。現代のシステムは通常、大容量記憶装置が遅れてCPU上にオーバープロビジョニングされています。コールドプールで圧縮を使用することで、Gravwellはストレージリンクへのストレスを軽減しながら、過剰なCPUサイクルを使用してデータを非同期的に解凍することができます。その結果、低速の大容量記憶装置で圧縮を使用すると検索が速くなります。

特筆すべき例外は、あまり圧縮されないデータです。この状況では、データを圧縮しようとすると、実際にはストレージスペースや速度が向上することなく、CPU時間が消費されます。生のネットワークトラフィックは、暗号化と高いエントロピーが効果的な圧縮を妨げる良い例です。コールドストレージプールで圧縮を無効にするには、 "Disable-Compression = true"ディレクティブを追加します。

圧縮を無効にし、ホットプールを合計ストレージで制限した場合のストレージ例

```
[Storage-Well "network"]
	Location=/mnt/xpoint/gravwell/network
	Cold-Location=/mnt/storage/gravwell_cold/network
	Tags=pcap
	Max-Hot-Data-GB=100
	Max-Cold-Data-GB=1000
	Delete-Frozen-Data=true
	Disable-Compression=true
```

### 制限ルールの相互作用

エージアウトルールを積み重ねて組み合わせることで、ストレージリソースを確実に制御できます。たとえば、Gravwellは、ホットプールで使用するための小さな高速ストレージプールと、コールドプールで使用するための大規模で低コストのディスクアレイを強く推奨しています。依然としてデータ保持ポリシーを遵守しながら、ストレージの制約を組み合わせて小さな高速プールを自由に利用できます。

データエージアウト制約は先着順で互いに独立して機能します。100 GBのストレージ制限に加えて7日の時間制限がWellに適用された場合、断片は7日またはプールが100 GBを超えるときのいずれか早い方で期限切れになります。1つのプールに対して複数の制約を1つのWellに組み合わせることは便利ですが、過度に積極的なエージアウト構成は予期しない動作を引き起こす可能性があることに注意してください。たとえば、Wellが7日間の保有期間を持っているが、5％のHot-Storage-Reserveも7日間の保有期間とは無関係に5％の保有期間を満たすことを試みます。各ageoutディレクティブは完全に独立して機能し、保存サイズまたはストレージ予約を設定することで、時間ベースのディレクティブをオーバーライドすることができます。

最大100GBのホットストレージを使用し、90日間データを保持するWell構成の例：

```
[Storage-Well "weblogs"]
	Location=/mnt/xpoint/gravwell/web
	Cold-Location=/mnt/storage/gravwell_cold/web
	Tags=apache
	Tags=nginx
	Tags=iis
	Max-Hot-Data-GB=100
	Cold-Duration=90D
	Delete-Frozen-Data=true
```

30日間データを保持しながら、ホットストレージボリュームに10％の空き容量を確保しようとするWell構成の例：

```
[Storage-Well "weblogs"]
	Location=/mnt/xpoint/gravwell/web
	Cold-Location=/mnt/storage/gravwell_cold/web
	Tags=apache
	Tags=nginx
	Tags=iis
	Hot-Storage-Reserve=10
	Cold-Duration=30D
	Delete-Frozen-Data=true
```

7日間または100GBをホットプールに保持し、20％が使用可能である限りすべてのデータをコールドプールに保持するWell構成例

```
[Storage-Well "weblogs"]
	Location=/mnt/xpoint/gravwell/web
	Cold-Location=/mnt/storage/gravwell_cold/web
	Tags=apache
	Tags=nginx
	Tags=iis
	Hot-Storage-Reserve=100
	Hot-Duration=7D
	Cold-Storage-Reserve=20
	Delete-Frozen-Data=true
```


