# 高度なGravwell設定

このドキュメントでは、Gravwellインストールのより高度な構成オプションについて説明します。これには、ストレージウェルの構成、データの有効期限切れ、およびマルチノードクラスタに関する情報が含まれます。

Gravwellはオプションで分散システムであり、Gravwellクラスターを構成する複数のインデクサーを可能にします。 デフォルトのインストールでは、Webサーバーとインデクサーの両方が同じマシンにインストールされますが、適切なライセンス構成では、クラスターの実行は単一インスタンスの実行と同じくらい簡単です。


## インストーラオプション

Gravwellインストーラーは、自動インストールまたはデプロイメントを容易にするためにいくつかのフラグをサポートしています。 以下のフラグがサポートされています。

| フラグ | 説明 |
|------|-------------|
| `--help` | インストーラのヘルプメニューを表示する |
| `--no-certs` | インストーラは自己署名証明書を生成しません
| `--no-questions` | すべてのデフォルトを想定し、自動的にEULAを受け入れる
| `--no-random-passwords` | ランダムな取り込みと制御の秘密を生成しません
| `--no-indexer` | Gravwellインデクサーコンポーネントをインストールしません
| `--no-webserver` | Gravwell Webサーバーコンポーネントをインストールしないでください
| `--no-searchagent` | Gravwell検索エージェントをインストールしません（通常--no-webserverと共に使用されます）。
| `--no-start` | インストール後にコンポーネ
| `--no-crash-report` | 自動デバッグレポートコンポーネントをインストールしない
| `--use-config` | 特定の設定ファイルを使う

### 高度なインストール要件の一般的なユースケース例

Gravwellを複数のインデクサーを持つクラスターにデプロイする場合は、インデクサーノードにWebサーバーコンポーネントをインストールしたくないでしょう。

自動展開ツールを使用している場合は、インストーラが停止して質問することは望ましくありません。

共有秘密を取り込んで制御するインデクサーのリストがすでにある場合は、インストール時に構成ファイルを指定すると、処理が大幅にスピードアップします。

Webサーバーをインストールしたりパスワードをランダム化したりせずにインデクサーコンポーネントをインストールするための引数リストの例は次のとおりです。

```
root@gravserver# bash gravwell_8675309_0.2.sh --no-questions --no-random-passwords --no-webserver
```

パスワードをランダム化することを選択した場合は、インデクサとWebサーバを調べて、gravwell.confファイルのControl-AuthパラメータがWebサーバと各インデクサに一致するようにする必要があります。

## 一般的な設定
Gravwellクラスターの構成は、最初から単純で効率的になるように設計されています。ただし、システムが極端に大きなシステムや、メモリの制約がある小さな組み込みおよび産業用デバイスをうまく利用できるようにするために、調整が必要なノブがあります。コア構成ファイルは、Webサーバーとインデクサーの両方で共有されるように設計されており、デフォルトでは`/opt/gravwell/etc/gravwell.conf`にあります。

設定オプションの詳細な一覧については、[このページ](parameters.md)を参照してください。

インデクサー設定の完全な例については、[デフォルト設定の例](indexer-default-config.md)を参照してください。

設定ファイル内の最も重要な項目は、`Ingest-Auth`, `Control-Auth`、および`Search-Agent-Auth`設定パラメータです。 `Control-Auth`パラメータは、Webサーバーとインデクサーが互いに認証するために使用する共有秘密です。攻撃者があなたのインデクサーと通信でき、`Control-Auth`トークンを持っていれば、攻撃者はそれらが保存しているデータに完全にアクセスすることができます。 `Ingest-Auth`トークンはインジェスターを検証するために使用され、タグを作成してデータをGravwellにプッシュする機能を制限します。 Gravwellはスピードを重視しています。つまり、`Ingest-Auth`トークンへのアクセス権を持つ攻撃者は、膨大な量のデータを非常に短時間でGravwellにプッシュできます。 `Search-Agent-Auth`トークンを使用すると、GravwellのSearch Agentユーティリティは自動的にWebサーバーに接続し、ユーザーに代わって検索を発行できます。これらのトークンは重要であり、慎重に保護する必要があります。

重要：クラスター化されたGravwellインストールでは、適切な相互通信を可能にするために、すべてのノードが同じ`Ingest-Auth`および`Control-Auth` の値で構成されていることが重要です。

## Webサーバ設定

Webサーバはすべての検索の中心点として機能し、Gravwellへの対話型インタフェースを提供します。 Webサーバーは大量のストレージを必要としませんが、検索によって大量のデータが返送された場合でも、ユーザーが結果を流動的にナビゲートできるように、非常に高速なストレージの小さなプールから恩恵を受けます。 Webサーバーも検索パイプラインに参加し、多くの場合、フィルタリング、メタデータ抽出、およびデータのレンダリングの一部を実行します。 Webサーバーをスペックするときは、適度なサイズのソリッドステートディスク（可能であればNVME）、16 GB以上のRAMのメモリプール、および少なくとも4つの物理コアをお勧めします。 Gravwellはきわめて並行して構築されているため、CPUコアとメモリを増設するとパフォーマンスが向上するだけです。 32GB以上のメモリを搭載したIntel E5またはAMD Epicチップが適しています。

2つの設定オプションは、検索にどのインデクサーを使用すべきかをWebサーバーに通知します。 `Remote-Indexers`オプションはインデクサーのIPを指定し、`Control-Auth`オプションはWebサーバーがインデクサーを認証するために使用する共有キーを指定します。 3つのインデクサーに接続しているWebサーバーの`gravwell.conf`には、次のものが含まれている可能性があります。

```
Control-Auth=MySuperSecureControlToken
Remote-Indexers=net:10.0.1.1:9404
Remote-Indexers=net:10.0.1.2:9404
Remote-Indexers=net:10.0.1.3:9404
```

<span style="color: red; ">注：上記のインデクサーは、デフォルトのポート9404で制御接続をlistenしています。 このポートは、インデクサのgravwell.confファイルのControl-Portオプションによって設定されます。</span>

### Webサーバ設定の落とし穴
*リモートインデクサーの欠落または構成ミス
* Control-Authトークンの欠落または不一致
* Webサーバーとバックエンドのライセンスの不一致
   *ウェブサーバーとインデクサーの両方に互換性のあるライセンスが必要です
* Webサーバーとインデクサー間の不十分なネットワーク接続
   *高遅延、低帯域幅、またはMTUサイズの構成ミス。
*インデクサーまたはWebサーバーポートへのアクセスをブロックするファイアウォール
   *デフォルトは9404です

## インデクサー構成

インデクサーはGravwellの保管センターであり、データの保管、検索、および処理を担当します。インデクサーは、クエリを実行するときに最初の重い作業を行います。最初にデータを見つけ、次にそれを検索パイプラインにプッシュします。検索パイプラインは、インデクサーができるだけ多くの作業を並行して実行できるように、できるだけ多くの照会を分散します。インデクサーは、高速で低遅延のストレージと可能な限り多くのRAMから恩恵を受けます。 Gravwellはファイルシステムのキャッシュを利用することができます。つまり、同じデータに対して複数のクエリを実行しているため、ディスクにアクセスする必要さえありません。 Gravwellがキャッシュされたデータで1ノードあたり5GB / s以上で動作するのを見ました。メモリが多いほど、より多くのデータをキャッシュできます。最大規模のマシンでさえもメモリ容量を超える大きなプールを検索する場合、高速RAIDアレイはスループットの向上に役立ちます。

インデクサーには8個のCPUコアを搭載した少なくとも32GBのメモリーを搭載することをお勧めします。可能であれば、Gravwellは、ホットウェルとして機能し、最新のデータを数日保持し、回転速度の遅いディスクプールにエージングアウトできる超高速NVMEソリッドステートディスクも推奨します。ホットウェルを使用すると、Gravwellが古いデータを整理および統合して、できるだけ効率的に検索できるようにしながら、最新のデータに非常に高速にアクセスできます。

インデクサのgravwell.confには、一般的な動作に影響を与えるいくつかの重要な設定オプションがあります。

* `Control-Port`は、インデクサーがWebサーバーからの着信接続をリッスンするポートを設定します。 デフォルト9404。
* `Control-Auth`は、ウェブサーバーが認証に使用する共有秘密を設定します。 デフォルトはランダムに生成された文字列です。
*「Ingest-Port」と「TLS-Ingest-Port」は、それぞれ暗号化されていない暗号化された取り込みトラフィックをリッスンするポートを指定します。
*「Ingest-Auth」は、データインジェスターがインデクサーの認証に使用する共有シークレットを設定します。 デフォルトはランダムに生成された文字列です。

インデクサーはデータをウェルに格納します。各ウェルにはいくつかのタグが格納されています。ウェルに100GBの "pcap"タグの付いたデータと10MBの "syslog"タグの付いたデータがある場合、syslogデータを検索すると、インデクサーはディスクからpcapデータを読み取る必要があるため、検索速度が低下します。このため、お客様が予想するタグ用に別のウェルを作成することを強くお勧めします。詳細については、「タグとウェル」のセクションを参照してください。

## タグとウェル

**タグ** は、異なる種類のデータを論理的に分離するための方法として使用されます。タグは、取り込み時にインジェスターによって適用されます（SimpleRelay、NetworkCaptureなど）。たとえば、syslogログ、Apacheログ、ネットワークパケット、ビデオストリーム、オーディオストリームなどに一意のタグを適用すると便利です。 **ウェル** は、実際に取り込まれたデータを整理して格納するストレージグループです。通常、ユーザーはユーザーと対話しませんが、各ウェルには約1.5日分のデータが格納されています。

タグをウェルに割り当てて、データストリームをより高速または大規模なストレージプールにルーティングできるようにすることができます。たとえば、高帯域幅リンクからの生のpcapストリームは、より高速のストレージプールに割り当てる必要がありますが、syslogまたはWebサーバーからの比較的少量のログエントリは高速ストレージを必要としません。タグからウェルへのマッピングは、1対1のマッピングです。 1つのタグを複数のウェルに割り当てることはできませんが、ウェルには複数のタグを含めることができます。データストリームを論理的および物理的に分離することで、さまざまなルールをさまざまなデータに適用できます。たとえば、15日ごとに、低帯域幅のストリームをずっと長く保ちながら、ネットワークトラフィックのような高帯域幅のストリームを期限切れまたは圧縮することが望ましい場合があります。システムがタグに基づいて適切なウェルをインテリジェントにクエリするので、論理的な分離も検索パフォーマンスを大幅に向上させます（たとえば、デフォルトという名前のsyslogエントリを検索する場合、Gravwellは他のウェルに関与しません）。

タグからウェルへのマッピングは `/opt/gravwell/etc/gravwell.conf`設定ファイルで定義されています。デフォルトでは、`Default-Well` のみが設定され、すべてのタグが受け入れられます。複数のウェルに関連付けられたタグを持つインデクサーの設定例は次のようになります。

```
[Default-Well]
	Location=/opt/gravwell/storage/default/

[storage-well "raw"]
	Location=/opt/gravwell/storage/raw/
	tags=pcap
	tags=video
```

このように、 "pcap"と "video"というタグが付けられたデータを格納するために、 "raw"という名前が付けられています。

### タグの制限と手引き

タグ名には英数字のみを含めることができます。ダッシュ、アンダースコア、特殊文字などはタグ名に使用できません。タグは「syslog」や「apache」のように、入力が簡単で使用中のデータの種類を反映した単純な名前にする必要があります。

デフォルトウェルは、他のウェルに明示的に割り当てられていないタグを持つすべてのエントリを受け取ります。たとえば、「syslog」および「apache」というタグが割り当てられているSyslogという名前のウェルが1つある場合、他のすべてのタグはデフォルトのウェルに移動します。インジェスターは依然としてgravwell.confファイルで明示的に定義されていないタグ名を持つエントリーを生成することができます。エントリは、デフォルトのウェル内の他のすべての未割り当てタグと混合されるだけです。

ウェル間でタグを再割り当てするとき、システムはデータを移動しません。タグをデフォルト以外のウェルに固定せずに「syslog」タグの下のデータを取り込む場合は、configファイルを変更して新しいウェルを定義するか、syslogタグを既存のウェルに割り当てます。 syslogタグは検索できなくなりました。エントリを回復することができる井戸とタグの移行のためのスタンドアロンツールへのアクセス、または古い井戸を最適化された/代替の構成に再導入するのを助けるためにsupport@gravwell.ioに連絡してください。

## データエージアウト

Gravwellは、データ管理ポリシーを個々の井戸に適用できるエージアウトシステムをサポートしています。 エージアウトポリシーは、データの保持、保管庫の利用率、および圧縮を制御します。 構成データの有効期間についての詳細は、[データエージアウト](ageout.md)セクションを参照してください。 

## ウェルレプリケーション
複数のインデクサーノードを持つGravwellクラスターは、ディスク障害または誤って削除された場合に、ノードが互いにデータを複製するように構成できます。複製の構成については、[複製の資料](replication.md)を参照してください。

## クエリアクセラレーション
Gravwellは個々の井戸に対して「アクセラレータ」の概念をサポートしています。これにより、取り込み時にデータにパーサーを適用して最適化ブロックを生成できます。 アクセラレータはクエリモジュールと同じくらい柔軟性があり、クエリ実行時に透過的に関与します。 アクセラレータは、特定のフィールド値を持つデータをすばやく絞り込む必要がある、針が空いた形のクエリに非常に便利です。 詳細および設定方法については、[アクセラレータ](accelerators.md)を参照してください。